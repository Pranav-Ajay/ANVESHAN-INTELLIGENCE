<!DOCTYPE html>
<html>
<head>
  <title>ANVESHAN INTELLIGENCE</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; }
    input, select, textarea { margin-bottom: 10px; padding: 5px; width: 100%; }
    button { padding: 8px 12px; margin-top: 5px; cursor:pointer; }
    .suspect-section { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; background:#f4f4f4; border-radius:8px; }
    #output { margin-top: 20px; padding: 10px; border: 1px solid #aaa; background: #f9f9f9; border-radius:10px; }
    #chatArea { padding: 10px; border: 1px solid #aaa; background: white; height: 250px; overflow-y: auto; border-radius: 10px; }

    .botMsg { background:#dbeeff; padding:10px; border-radius:10px; margin:5px 0; width:80%; }
    .userMsg { background:#d7ffd7; padding:10px; border-radius:10px; margin:5px 0; width:80%; margin-left:auto; text-align:right; }
  </style>
</head>

<body>

<!-- LEFT PANEL -->
<div style="width:450px; height:1000px; background-color:#215F9A; left:0; top:0; position:fixed;">
  <img width="400" height="400" src="AI.png">
  <div style="margin-left:20px;">
    <h2 style="color:white;">History</h2>
    <ol id="y" style="color:white;"></ol>
  </div>
</div>

<!-- RIGHT PANEL -->
<div style="width:450px; height:1000px; background-color:#215F9A; right:0; top:0; position:fixed;">
  <div style="right:7%; top:10%; position:fixed; color:white;">
    <img id="ds" width=200 height=250><br><br><br><br>
    Name:<p id="k"></p><br><br>
    Contact:<p id="l"></p><br><br>
    Email:<p id="m"></p><br><br>
    Signature:<br><br><img id="de" width=200 height=100>
  </div>
</div>

<!-- BOTTOM CHAT INPUT -->
<div style="position:fixed; bottom:5%; right:30%;">
  <input id="chatInput" style="width:600px; background-color:#BDC7D1; padding:10px; border-radius:20px;" placeholder="Answer here...">
  <button onclick="sendAnswer()">â†’</button>
</div>

<!-- FOOTER -->
<div style="bottom:0; position:fixed; left:0;width:100%;background-color:blue;color:white;display:flex;justify-content:center;align-items:center;padding:10px;text-align:center;">
  Anveshan Intelligence can make mistakes, please use it carefully.
</div>

<!-- MAIN CENTER -->
<div style="display:flex; justify-content:center;">
  <div class="x" style="width:600px; display:flex; flex-direction:column; gap:30px; margin-top:50px; height:800px">

    <h2>ANVESHAN Investigation Assistant</h2>

    <div>
      <h3>Police Conversation</h3>
      <div id="chatArea"></div>
    </div>

    <div>
      <h3>Investigation Report (Live Dashboard)</h3>
      <div id="output"></div>
    </div>

    <div>
      <h3>Suspect Interviews</h3>
      <div id="suspectInterviewSection"></div>
    </div>

  </div>
</div>

<script>
let caseData = {
  FIR: "",
  incident: {},
  victim: {},
  suspects: [],
  chatHistory: [],
  stage: "FIR",
  currentSuspectIndex: 0
};

let questionFlow = [
  { key: "FIR", question: "Provide FIR details (full text)." },
  { key: "incidentType", question: "What type of incident is it? (Murder/Theft/Assault/etc.)" },
  { key: "location", question: "Where did the incident happen? (exact place)" },
  { key: "date", question: "What is the date of incident?" },
  { key: "time", question: "What is the approximate time of incident?" },
  { key: "weapon", question: "Was any weapon used? If yes, which weapon?" },
  { key: "victimAlive", question: "Is the victim alive? (yes/no)" },
  { key: "statement", question: "Provide the victim/witness statement describing the incident." }
];

let currentQuestionIndex = 0;

function addMessage(text, sender){
  let chatArea = document.getElementById("chatArea");
  let div = document.createElement("div");
  div.className = sender === "bot" ? "botMsg" : "userMsg";
  div.innerText = text;
  chatArea.appendChild(div);
  chatArea.scrollTop = chatArea.scrollHeight;

  caseData.chatHistory.push(sender.toUpperCase() + ": " + text);
  updateHistoryPanel();
}

function updateHistoryPanel(){
  let y = document.getElementById("y");
  y.innerHTML = "";
  caseData.chatHistory.slice(-10).forEach(item=>{
    let li = document.createElement("li");
    li.innerText = item;
    y.appendChild(li);
  });
}

function askNextQuestion(){
  if(currentQuestionIndex < questionFlow.length){
    addMessage(questionFlow[currentQuestionIndex].question, "bot");
  } else {
    addMessage("Initial case intake complete. Running TCI, TCA, RLE/RLI, FCI and EAS...", "bot");
    runModels();
    addMessage("Now I will start suspect interviews like real police.", "bot");
    startSuspectInterviews();
  }
}

function sendAnswer(){
  let input = document.getElementById("chatInput");
  let answer = input.value.trim();
  if(!answer) return;

  addMessage(answer, "user");
  input.value = "";

  let currentKey = questionFlow[currentQuestionIndex]?.key;

  if(currentKey === "FIR") caseData.FIR = answer;
  if(currentKey === "incidentType") caseData.incident.type = answer;
  if(currentKey === "location") caseData.incident.location = answer;
  if(currentKey === "date") caseData.incident.date = answer;
  if(currentKey === "time") caseData.incident.time = answer;
  if(currentKey === "weapon") caseData.incident.weapon = answer;
  if(currentKey === "victimAlive") caseData.victim.alive = answer.toLowerCase();
  if(currentKey === "statement") caseData.victim.statement = answer;

  currentQuestionIndex++;

  if(currentQuestionIndex < questionFlow.length){
    askNextQuestion();
  } else {
    askNextQuestion();
  }
}

/* =================== MODELS =================== */

// TCI - FIR internal contradictions
function TCI(){
  let fir = (caseData.FIR || "").toLowerCase();
  let issues = [];

  if(fir.includes("morning") && fir.includes("midnight")) issues.push("Time contradiction inside FIR (morning + midnight).");
  if(fir.includes("knife") && fir.includes("gun")) issues.push("Weapon contradiction inside FIR (knife + gun).");
  if(fir.includes("inside") && fir.includes("outside")) issues.push("Place contradiction inside FIR (inside + outside).");

  caseData.TCI = { status: issues.length ? "Inconsistent" : "Consistent", issues };
}

// TCA - FIR vs statement contradictions
function TCA(){
  let fir = (caseData.FIR || "").toLowerCase();
  let stmt = (caseData.victim.statement || "").toLowerCase();
  let contradictions = [];

  if(fir.includes("knife") && stmt.includes("gun")) contradictions.push("Weapon mismatch: FIR says knife, statement says gun.");
  if(fir.includes("gun") && stmt.includes("knife")) contradictions.push("Weapon mismatch: FIR says gun, statement says knife.");
  if(fir.includes("night") && stmt.includes("morning")) contradictions.push("Time mismatch: FIR says night, statement says morning.");
  if(fir.includes("morning") && stmt.includes("night")) contradictions.push("Time mismatch: FIR says morning, statement says night.");

  caseData.TCA = { status: contradictions.length ? "Contradictions Found" : "Consistent", contradictions };
}

// RLE / RLI extraction
function RLE(text){
  let suspects = [];
  let locations = [];
  let traits = [];

  if(!text) return {suspects, locations, traits};

  const suspectTriggers = ["named","called","by","attacked","met","with","saw"];
  const locationKeywords = ["mall","market","park","station","hospital","school","street","road","bridge"];
  const traitKeywords = ["tall","short","beard","scar","jacket","mask","black","white","blue","red"];

  let words = text.split(/\s+/);

  words.forEach((word,i)=>{
    if(suspectTriggers.includes(word.toLowerCase())){
      let name = words[i+1] || "";
      name = name.replace(/[^a-zA-Z]/g,"");
      if(name.length>1) suspects.push(name);
    }
  });

  locationKeywords.forEach(loc=>{
    if(text.toLowerCase().includes(loc)) locations.push(loc);
  });

  traitKeywords.forEach(tr=>{
    if(text.toLowerCase().includes(tr)) traits.push(tr);
  });

  return {
    suspects: [...new Set(suspects)],
    locations: [...new Set(locations)],
    traits: [...new Set(traits)]
  };
}

function RLI(){
  let combined = (caseData.FIR || "") + " " + (caseData.victim.statement || "");
  let extracted = RLE(combined);

  extracted.suspects.forEach(name=>{
    if(!caseData.suspects.some(s=>s.name.toLowerCase()===name.toLowerCase())){
      caseData.suspects.push({
        name,
        reason: "Mentioned in FIR/Statement",
        location: extracted.locations[0] || caseData.incident.location || "",
        traits: extracted.traits,
        contradictions: [],
        alibi: "",
        interviewStatement: "",
        evidenceScore: 10,
        finalScore: 0,
        probability: 0
      });
    }
  });

  if(caseData.suspects.length === 0){
    caseData.suspects.push({
      name: "Unknown Individual",
      reason: "No name found, only description available",
      location: extracted.locations[0] || caseData.incident.location || "",
      traits: extracted.traits,
      contradictions: [],
      alibi: "",
      interviewStatement: "",
      evidenceScore: 10,
      finalScore: 0,
      probability: 0
    });
  }

  caseData.RLI = extracted;
}

// FCI scoring
function FCI(){
  caseData.suspects.forEach((s,index)=>{
    let score = 10;
    if(s.name !== "Unknown Individual") score += 15;
    if(s.location) score += 8;
    score += s.traits.length * 5;
    if(s.alibi === "") score += 10;
    score += s.contradictions.length * 12;
    score += index * 2;
    s.evidenceScore = score;
  });

  caseData.FCI = { suspects: caseData.suspects };
}

// EAS scoring
function EAS(){
  let total = 0;

  caseData.suspects.forEach(s=>{
    let weight = 1;
    if(s.traits.length) weight += 0.2 * s.traits.length;
    if(s.location) weight += 0.3;
    if(s.alibi === "") weight += 0.4;
    if(s.interviewStatement) weight += 0.5;
    if(s.contradictions.length) weight += 0.5;

    s.finalScore = Math.round(s.evidenceScore * weight);
    total += s.finalScore;
  });

  caseData.suspects.forEach(s=>{
    s.probability = total ? Math.round((s.finalScore / total) * 100) : 0;
  });

  caseData.EAS = { totalEvidenceScore: total };
}

function runModels(){
  TCI();
  TCA();
  RLI();
  FCI();
  EAS();
  renderOutput();
}

/* =================== OUTPUT =================== */
function renderOutput(){
  const outputDiv = document.getElementById("output");

  outputDiv.innerHTML = `
    <h3>Investigation Report</h3>

    <p><b>Stage:</b> ${caseData.stage}</p>

    <h4>TCI (FIR Consistency)</h4>
    <p><b>Status:</b> ${caseData.TCI?.status}</p>
    <p>${caseData.TCI?.issues?.join("<br>") || "No contradictions found."}</p>

    <h4>TCA (FIR vs Statement)</h4>
    <p><b>Status:</b> ${caseData.TCA?.status}</p>
    <p>${caseData.TCA?.contradictions?.join("<br>") || "No contradictions found."}</p>

    <h4>RLI / RLE Extracted Leads</h4>
    <p><b>Suspects:</b> ${(caseData.RLI?.suspects || []).join(", ") || "None"}</p>
    <p><b>Traits:</b> ${(caseData.RLI?.traits || []).join(", ") || "None"}</p>
    <p><b>Locations:</b> ${(caseData.RLI?.locations || []).join(", ") || "None"}</p>

    <h4>Suspects & Probability (FCI + EAS)</h4>
    ${caseData.suspects.map(s=>`
      <div style="border:1px solid #ccc; padding:10px; margin-bottom:10px; border-radius:10px; background:#fff;">
        <b>Name:</b> ${s.name}<br>
        <b>Reason:</b> ${s.reason}<br>
        <b>Location:</b> ${s.location || "Unknown"}<br>
        <b>Traits:</b> ${s.traits.join(", ") || "None"}<br>
        <b>Evidence Score (FCI):</b> ${s.evidenceScore}<br>
        <b>Final Score (EAS):</b> ${s.finalScore}<br>
        <b>Probability:</b> ${s.probability}%<br>
        <b>Alibi:</b> ${s.alibi || "Not given"}<br>
        <b>Contradictions:</b> ${s.contradictions.join(", ") || "None"}<br>
      </div>
    `).join("")}

    <p><b>Total Evidence Score:</b> ${caseData.EAS?.totalEvidenceScore || 0}</p>
  `;
}

/* =================== SUSPECT INTERVIEW SYSTEM =================== */

function startSuspectInterviews(){
  caseData.stage = "Suspect Interviews";
  runModels();
  SIM();
}

function SIM(){
  const section = document.getElementById("suspectInterviewSection");
  section.innerHTML = "";

  caseData.suspects.forEach((s,index)=>{
    section.innerHTML += `
      <div class="suspect-section">
        <b>Suspect ${index+1}: ${s.name}</b><br><br>

        <label>Police Question:</label><br>
        <i>Where were you on ${caseData.incident.date || "Unknown Date"} at ${caseData.incident.time || "Unknown Time"}?</i><br><br>

        <textarea id="suspectStmt_${index}" placeholder="Enter statement of ${s.name}"></textarea>
        <button onclick="saveInterview(${index})">Save Statement</button>
      </div>
    `;
  });
}

function saveInterview(index){
  let textarea = document.getElementById(`suspectStmt_${index}`);
  if(!textarea) return;

  let statement = textarea.value.trim();
  if(!statement){ alert("Statement cannot be empty."); return; }

  let suspect = caseData.suspects[index];
  suspect.interviewStatement = statement;
  suspect.alibi = statement;

  // weak alibi detection
  if(statement.toLowerCase().includes("alone")){
    suspect.contradictions.push("Weak alibi: suspect claims alone, no witness.");
  }

  // extract new leads from suspect statement
  let extracted = RLE(statement);

  extracted.traits.forEach(t=>{
    if(!suspect.traits.includes(t)) suspect.traits.push(t);
  });

  if(!suspect.location && extracted.locations.length>0){
    suspect.location = extracted.locations[0];
  }

  extracted.suspects.forEach(name=>{
    if(!caseData.suspects.some(s=>s.name.toLowerCase()===name.toLowerCase())){
      caseData.suspects.push({
        name,
        reason: "Mentioned in suspect interview",
        location: extracted.locations[0] || "",
        traits: extracted.traits,
        contradictions: [],
        alibi: "",
        interviewStatement: "",
        evidenceScore: 10,
        finalScore: 0,
        probability: 0
      });
    }
  });

  runModels();
  SIM();
  alert("Statement saved. Scores updated (FCI + EAS).");
}

/* =================== START =================== */

addMessage("Welcome to ANVESHAN Intelligence.", "bot");
addMessage("I will investigate like a real police officer. Answer step-by-step.", "bot");
askNextQuestion();

</script>

</body>
</html>
