<script>

/* ================= PROFILE LOAD ================= */

let profileImg = document.getElementById("ds");
profileImg.src = localStorage.getItem("profilePic");

let signImg = document.getElementById("de");
signImg.src = localStorage.getItem("signaturePic");

document.getElementById("k").innerText = localStorage.getItem("username1");
document.getElementById("l").innerText = localStorage.getItem("username2");
document.getElementById("m").innerText = localStorage.getItem("username4");

/* ================= TCI CHECK FUNCTION ================= */

function check() {

  let inputs = document.querySelectorAll("#details input, #details select");
  let allFilled = true;

  inputs.forEach(function(input) {
    if (input.value.trim() === "") {
      input.style.border = "2px solid red";
      allFilled = false;
    } else {
      input.style.border = "";
    }
  });

  if (!allFilled) return;

  let result = answer();

  let container = document.querySelector(".x");

  let botDiv = document.createElement("div");
  botDiv.style.display = "flex";
  botDiv.style.justifyContent = "flex-start";

  let botText = document.createElement("pre");
  botText.innerText =
    "TCI RESULT\n" +
    "Status: " + result.status + "\n" +
    "Score: " + result.consistencyScore + "%\n" +
    "Issues: " +
    (result.inconsistenciesFound.length
      ? result.inconsistenciesFound.join(", ")
      : "None");

  botDiv.appendChild(botText);
  container.appendChild(botDiv);

  /* Ask victim status */
  let statusDiv = document.createElement("div");
  statusDiv.style.display = "flex";
  statusDiv.style.justifyContent = "flex-start";

  let statusText = document.createElement("h2");
  statusText.innerText = "Is the victim alive?";

  statusDiv.appendChild(statusText);
  container.appendChild(statusDiv);
}

/* ================= TCI MODEL ================= */

function answer() {

  const data = {
    complainantName: document.querySelector("#details li:nth-child(1) input")?.value || "",
    dob: document.querySelector("#details li:nth-child(3) input")?.value || "",
    age: document.querySelector("#details li:nth-child(6) input")?.value || "",
    date: document.querySelector("#details li:nth-child(15) input")?.value || "",
    startTime: document.querySelector("#details li:nth-child(16) input")?.value || "",
    endTime: document.querySelector("#details li:nth-child(17) input")?.value || "",
    weaponUsed: document.querySelector("#details li:nth-child(14) input")?.value || "",
    incidentType: document.querySelector("#details li:nth-child(20) input")?.value || "",
    location: document.querySelector("#details li:nth-child(19) input")?.value || ""
  };

  let inconsistencies = [];
  let confidenceScore = 100;

  /* Age validation */
  if (data.dob && data.age) {
    const birthYear = new Date(data.dob).getFullYear();
    const currentYear = new Date().getFullYear();
    const calculatedAge = currentYear - birthYear;

    if (Math.abs(calculatedAge - parseInt(data.age)) > 1) {
      inconsistencies.push("Age does not match DOB.");
      confidenceScore -= 15;
    }
  }

  /* Time validation */
  if (data.startTime && data.endTime && data.startTime > data.endTime) {
    inconsistencies.push("Start time is later than End time.");
    confidenceScore -= 20;
  }

  if (!data.incidentType) {
    inconsistencies.push("Incident type missing.");
    confidenceScore -= 15;
  }

  if (!data.location) {
    inconsistencies.push("Location missing.");
    confidenceScore -= 15;
  }

  if (!data.date) {
    inconsistencies.push("Incident date missing.");
    confidenceScore -= 15;
  }

  return {
    model: "TCI - Internal Consistency",
    extractedData: data,
    inconsistenciesFound: inconsistencies,
    consistencyScore: confidenceScore,
    status:
      inconsistencies.length === 0
        ? "Internally Consistent"
        : "Inconsistencies Detected"
  };
}

/* ================= CHAT SYSTEM ================= */

function execute() {

  let container = document.querySelector(".x");
  let inputValue = document.getElementById("chatInput").value.trim().toLowerCase();

  if (!inputValue) return;

  let userDiv = document.createElement("div");
  userDiv.style.display = "flex";
  userDiv.style.justifyContent = "flex-end";

  let userText = document.createElement("h2");
  userText.innerText = inputValue;

  userDiv.appendChild(userText);
  container.appendChild(userDiv);

  let botDiv = document.createElement("div");
  botDiv.style.display = "flex";
  botDiv.style.justifyContent = "flex-start";

  let botText = document.createElement("h2");

  if (inputValue === "yes") {
    botText.innerText = "Ok, please give victim's statement.";
  } 
  else if (inputValue === "no") {
    botText.innerText = "Proceed to evidence collection.";
  } 
  else {
    botText.innerText = "Please answer yes or no.";
  }

  botDiv.appendChild(botText);
  container.appendChild(botDiv);

  document.getElementById("chatInput").value = "";
}

/* ================= DELETE CHAT ================= */

function ask() {
  let outcome = confirm("Are you sure you want to delete this chat?");
  if (outcome) window.location.href = "chatbot.html";
}

/* ================= LOGOUT ================= */

function logout() {
  let res = confirm("Are you sure you want to log out?");
  if (res) {
    localStorage.clear();
    window.location.href = "index.html";
  }
}

</script>
